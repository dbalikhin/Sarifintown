@page "/aichat"
@using Microsoft.SemanticKernel
@using Microsoft.SemanticKernel.ChatCompletion
@using Microsoft.SemanticKernel.Connectors.OpenAI
@using MudBlazor
@using System.ComponentModel
@using Sarifintown.Services
@inject KernelService KernelService
@inject IJSRuntime JSRuntime
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="3">
        <MudToolBar>
            <MudText Typo="Typo.h6">Local &amp; Cloud AI Chat</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Settings" OnClick="ToggleSettings" />
        </MudToolBar>

        <MudCollapse Expanded="_showSettings">
            <MudPaper Class="pa-4" Elevation="0">
                <MudText Typo="Typo.h6" GutterBottom="true">AI Settings</MudText>
                <MudText Typo="Typo.body2" Class="mb-4">
                    Your settings are saved securely in your browser's local storage and are never sent to any server.
                </MudText>
                <MudTextField @bind-Value="_editSettings.ModelId" Label="Model ID" Variant="Variant.Outlined" Margin="Margin.Dense" />
                <MudTextField @bind-Value="_editSettings.Endpoint" Label="API Endpoint" Variant="Variant.Outlined" Margin="Margin.Dense" />
                <MudTextField @bind-Value="_editSettings.ApiKey" Label="API Key (Optional)" HelperText="Required for cloud services like OpenAI." Variant="Variant.Outlined" Margin="Margin.Dense" InputType="InputType.Password" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveSettingsAsync" Class="mt-4">Save and Reconnect</MudButton>
            </MudPaper>
        </MudCollapse>

        @if (!KernelService.IsInitialized)
        {
            <MudAlert Severity="Severity.Warning" Class="ma-4">
                AI Service is not configured. Please open the settings panel and save your configuration.
            </MudAlert>
        }
        else
        {
            <div class="pa-4" style="height: 500px; overflow-y: auto;" id="chatContainer" @ref="_chatContainer">
                <MudStack Spacing="2">
                    @foreach (var message in _chatHistory)
                    {
                        <div class="d-flex @(message.Role == AuthorRole.User ? "flex-row-reverse" : "")">
                            <MudPaper Class="pa-3" Elevation="2" Style="@(message.Role == AuthorRole.User ? "background-color: var(--mud-palette-primary); color: white;" : "")">
                                <MudText Typo="Typo.body1">@((MarkupString)message.Text)</MudText>
                            </MudPaper>
                        </div>
                    }
                    @if (_isAwaitingResponse)
                    {
                        <div class="d-flex mt-2">
                            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                        </div>
                    }
                </MudStack>
            </div>

            <MudPaper Elevation="2" Class="pa-2">
                <MudTextField @bind-Value="_userInput"
                              Placeholder="Ask me anything..."
                              Variant="Variant.Outlined"
                              @onkeydown="HandleKeyDown"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Send"
                              OnAdornmentClick="SendMessageAsync"
                              Disabled="_isAwaitingResponse"
                              Immediate="true" />
            </MudPaper>
        }
    </MudPaper>
</MudContainer>

@code {
    private string _userInput = string.Empty;
    private readonly List<ChatMessage> _chatHistory = new();
    private bool _isAwaitingResponse;
    private ElementReference _chatContainer;
    private bool _showSettings;
    private AiSettings _editSettings = new();

    private class ChatMessage
    {
        public string Text { get; set; } = string.Empty;
        public AuthorRole Role { get; set; }
    }

    protected override void OnInitialized()
    {
        KernelService.OnChange += OnKernelServiceChanged;

        if (KernelService.IsInitialized && !_chatHistory.Any())
        {
            _chatHistory.Add(new ChatMessage { Text = "Hello! I'm ready to chat. How can I help?", Role = AuthorRole.Assistant });
        }
    }

    private void OnKernelServiceChanged()
    {
        // When the service state changes, ask the UI to re-render
        InvokeAsync(StateHasChanged);
    }

    private void ToggleSettings()
    {
        if (!_showSettings)
        {
            // Create a clean copy of the current settings for editing
            _editSettings = new AiSettings
            {
                ModelId = KernelService.Settings.ModelId,
                Endpoint = KernelService.Settings.Endpoint,
                ApiKey = KernelService.Settings.ApiKey
            };
        }
        _showSettings = !_showSettings;
    }

    private async Task SaveSettingsAsync()
    {
        _showSettings = false;
        await KernelService.SaveSettingsAndReloadAsync(_editSettings);

        // Clear history and add welcome message if initialization was successful
        if (KernelService.IsInitialized)
        {
            _chatHistory.Clear();
            _chatHistory.Add(new ChatMessage { Text = "Service reconfigured! How can I help?", Role = AuthorRole.Assistant });
        }
    }

    //protected override async Task OnAfterRenderAsync(bool firstRender) => await ScrollToBottomAsync();

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessageAsync();
        }
    }

    private async Task SendMessageAsync()
    {
        if (string.IsNullOrWhiteSpace(_userInput) || _isAwaitingResponse || !KernelService.IsInitialized || KernelService.ChatCompletionService == null || KernelService.Kernel == null)
        {
            return;
        }

        _isAwaitingResponse = true;
        var userMessageText = _userInput;
        _chatHistory.Add(new ChatMessage { Text = userMessageText, Role = AuthorRole.User });
        _userInput = string.Empty;
        StateHasChanged();
        //await ScrollToBottomAsync();

        try
        {
            var settings = new OpenAIPromptExecutionSettings { ToolCallBehavior = ToolCallBehavior.AutoInvokeKernelFunctions };
            var history = new ChatHistory();
            foreach (var msg in _chatHistory)
            {
                history.AddMessage(msg.Role, msg.Text);
            }

            var streamingResult = KernelService.ChatCompletionService.GetStreamingChatMessageContentsAsync(history, executionSettings: settings, kernel: KernelService.Kernel);
            var assistantMessage = new ChatMessage { Text = "", Role = AuthorRole.Assistant };
            _chatHistory.Add(assistantMessage);

            await foreach (var content in streamingResult)
            {
                assistantMessage.Text += content.Content;
                StateHasChanged();
                //await ScrollToBottomAsync();
            }
        }
        catch (Exception ex)
        {
            _chatHistory.Add(new ChatMessage { Text = $"An error occurred: {ex.Message}", Role = AuthorRole.Assistant });
        }
        finally
        {
            _isAwaitingResponse = false;
            StateHasChanged();
        }
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            if (KernelService.IsInitialized)
            {
                await JSRuntime.InvokeVoidAsync("document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight");
            }
        }
        catch (JSException) { /* Safe to ignore */ }
    }

    public void Dispose()
    {
        KernelService.OnChange -= OnKernelServiceChanged;
    }
}